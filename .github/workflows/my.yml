name: Django CI

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master

jobs:
  build:

    runs-on: ubuntu-latest

#    services:
#      mysql:
#        image: mysql:5.7
#        env:
#            MYSQL_ALLOW_EMPTY_PASSWORD: yes
#            MYSQL_DATABASE: myapp
#        ports:
#            - 3306:3306
#        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.8]

    steps:
    - uses: shogo82148/actions-setup-mysql@v1.3.0
      with:
        mysql-version: '5.7'
        auto-start: true
    - name: create test database
      run: mysql -h 127.0.0.1 -P 3306 -u root -e 'CREATE DATABASE test_db;'
    - name: show databases
      run: mysql -h 127.0.0.1 -P 3306 -u root -e 'SHOW DATABASES;'
    - name: setup user
      run: mysql -h 127.0.0.1 -P 3306 -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';"
    - name: flush privileges
      run: mysql -h 127.0.0.1 -P 3306 -u root -e 'FLUSH PRIVILEGES' -ppassword
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

#    - name: Initiate Services
#      run: |
#        sudo /etc/init.d/mysql stop
#        sudo  service mysql stop
#        sudo killall -KILL mysql mysqld_safe mysqld
#        sudo /etc/init.d/mysql start
#        sudo service mysql start

#    - name: Reset mysql password
#      run: |
#        cat <<EOF | mysql -h 127.0.0.1 -u root --password=root
#          UPDATE mysql.user SET authentication_string = null WHERE user = 'root';
#          FLUSH PRIVILEGES;
#        EOF

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip uninstall -y mysqlclient
        pip install --no-binary mysqlclient mysqlclient
    - name: Run Tests
      run: |
        python manage.py test
